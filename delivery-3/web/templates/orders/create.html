{% extends 'base.html' %} {% block header %}
<h1>{% block title %}Place order{% endblock %}</h1>
{% endblock %} {% block content %}
<form id="myForm" method="post">
    <label for="order_no">Order number</label>
    <input
        name="order_no"
        id="order_no"
        type="number"
        value="{{ request.form['order_no'] }}"
        required
    >
    <label for="cust_no">Customer number</label>
    <input
        name="cust_no"
        id="cust_no"
        type="number"
        value="{{ request.form['cust_no'] }}"
        required
    >
    <label for="date">Date</label>
    <input
        name="date"
        id="date"
        type="date"
        required
    >
    <label for="products-container">Products</label>
    <div class="products-container"></div>
    <div class="btn" onclick="add_product()">+ Add product</div>
    <input type="submit" value="Create">
</form>
<script>
    const products = document.querySelector(".products-container");

    function add_product(first = false) {
        const new_product = document.createElement("div");
        new_product.className = "product-container";

        const product_sku = document.createElement("input");
        product_sku.className = "product-sku";
        product_sku.type = "text";
        product_sku.placeholder = "SKUxxx";
        product_sku.required = true;

        const product_qty = document.createElement("input");
        product_qty.className = "product-qty";
        product_qty.type = "number";
        product_qty.placeholder = "1";
        product_qty.value = 1;
        product_qty.required = true;
        product_qty.min = 1;

        new_product.appendChild(product_sku);
        new_product.appendChild(product_qty);

        if (!first) {
            const delete_btn = document.createElement("div");
            delete_btn.className = "delete-btn";
            delete_btn.textContent = "Delete";
            delete_btn.onclick = (e) => products.removeChild(new_product);
            new_product.appendChild(delete_btn);
        }

        products.appendChild(new_product);
    }

    function submit_form(event) {
        const myForm = document.querySelector("#myForm");

        if (!myForm.reportValidity()) return;

        const formData = event.formData;

        // fetch all products and stringify them
        let products_array = [];
        for (const element of products.children) {
            const product_sku = element.firstChild;
            const product_qty = element.children[1]

            products_array.push({
                sku: product_sku.value,
                qty: product_qty.value
            });
        }

        formData.set("products", JSON.stringify(products_array));

        myForm.submit()
    }

    window.addEventListener("load", () => add_product(first = true));
    window.addEventListener("formdata", submit_form)
</script>
{% endblock %}
